# Methane Kit CI configuration for Sonar Cloud static code analysis on MacOS/Linux platform
# https://aka.ms/yaml

steps:

  - script: |
      mkdir -p $(buildDir)
    displayName: 'Make build directories for $(platform) $(configuration)'

  - task: CMake@1
    displayName: 'Generate with $(generatorName) for $(platform) $(configuration)'
    inputs:
      workingDirectory: $(buildDir)
      cmakeArgs: '-G $(generatorName) -DCMAKE_BUILD_TYPE=$(configuration) -DCMAKE_INSTALL_PREFIX:PATH=$(buildInstallDir) $(cmakeFlags) $(rootDir)'

  - script: |
      curl '$(sonar.BuildWrapperUrl)' --output build-wrapper.zip
      unzip build-wrapper.zip
    workingDirectory: $(buildDir)
    displayName: 'Download and unpack Sonar Build-Wrapper'

  - task: Cache@2
    displayName: 'Sonar Scanner Cache'
    inputs:
      key: 'SonarCache | $(sonar.ProjectKey) | $(Build.SourceBranchName) | $(configuration) | $(platform) | "$(Agent.OS)"'
      path: $(sonar.CacheDir)

  - task: SonarCloudPrepare@1
    displayName: 'Prepare Sonar Cloud Scanner'
    inputs:
      SonarCloud: $(sonar.CloudName)
      organization: $(sonar.Organization)
      scannerMode: 'CLI'
      configMode: 'manual'
      cliProjectKey: $(sonar.ProjectKey)
      cliProjectVersion: $(product.Version.Full)
      cliSources: $(sonar.Sources)
      extraProperties: |
        sonar.branch.name=$(Build.SourceBranchName)
        sonar.tests=$(sonar.Tests)
        sonar.cfamily.build-wrapper-output=$(buildDir)/BuildWrapperOutput
        sonar.cfamily.cache.path=$(sonar.CacheDir)
        sonar.cfamily.cache.enabled=true
        sonar.cfamily.threads=4
        sonar.testExecutionReportPaths=$(installDir)/Tests/Results/MethaneDataEventsTest.xml,$(installDir)/Tests/Results/MethaneDataRangeSetTest.xml,$(installDir)/Tests/Results/MethanePlatformInputTest.xml,$(installDir)/Tests/Results/MethaneGraphicsCameraTest.xml
        sonar.coverageReportPaths=$(installDir)/Tests/Coverage/Report/SonarQube.xml

  - script: |
      $(sonar.BuildWrapperExe) --out-dir BuildWrapperOutput $(sonar.BuildCommand)
    workingDirectory: $(buildDir)
    displayName: 'Build under Sonar Build-Wrapper with $(generatorName) for $(platform) $(configuration)'

  - bash: |
      result_ext='.xml'
      echo Running unit-tests in directory $PWD
      mkdir Results
      for test_exe in *Test
      do
        ./$test_exe -r sonarqube -o "Results/$test_exe$result_ext"
        echo  - $test_exe - completed with $? exit status
        if [ -f default.profraw ]; then
          mv default.profraw $test_exe.profraw
        fi
      done
    workingDirectory: '$(installDir)/Tests'
    condition: eq( variables['Agent.OS'], 'Darwin' )
    displayName: 'Collect code coverage from all unit-tests in install directory on MacOS'

  - bash: |
      result_ext='.xml'
      echo Running unit-tests in directory $PWD
      mkdir Results
      for test_exe in *Test
      do
        ./$test_exe -r sonarqube -o "Results/$test_exe$result_ext"
        echo  - $test_exe - completed with $? exit status, files generated:
        gcov
        echo    - gcov exist status $?
      done
      echo List of files generated in directory $PWD
      ls -la
    workingDirectory: '$(installDir)/Tests'
    condition: eq( variables['Agent.OS'], 'Linux' )
    displayName: 'Collect code coverage from all unit-tests in install directory on Linux'

  - bash: |
      prof_data_ext='.profdata'
      prof_raw_ext='.profraw'
      lcov_ext='.lcov'
      echo Converting LLVM code coverage data to lcov text format in directory $PWD
      mkdir Coverage
      for test_exe in *Test
      do
        if [ ! -f "$test_exe$prof_raw_ext" ]; then
          continue
        fi
        xcrun llvm-profdata merge -o "$test_exe$prof_data_ext" "$test_exe$prof_raw_ext"
        xcrun llvm-cov export -format lcov -instr-profile="$test_exe$prof_data_ext" ./$test_exe > "./Coverage/$test_exe$lcov_ext"
        echo  - Converted code coverage from "$test_exe$prof_raw_ext" to lcov text format "./Coverage/$test_exe$lcov_ext", $? exit status
      done
      echo List of generated coverage files in directory $PWD/Coverage
      ls -la ./Coverage
    workingDirectory: '$(installDir)/Tests'
    condition: eq( variables['Agent.OS'], 'Darwin' )
    displayName: 'Convert LLVM code coverage data to lcov text format on MacOS'

  - task: reportgenerator@4
    displayName: 'Merge per-test lcov code coverage into one report on MacOS'
    condition: eq( variables['Agent.OS'], 'Darwin' )
    inputs:
      reports: '$(installDir)/Tests/Coverage/*.lcov'
      targetdir: '$(installDir)/Tests/Coverage/Report'
      reporttypes: 'Cobertura;SonarQube'
      tag: '$(product.Version.Full)'

  - task: reportgenerator@4
    displayName: 'Merge per-test gcov code coverage into one report on Linux'
    condition: eq( variables['Agent.OS'], 'Linux' )
    inputs:
      reports: '$(installDir)/Tests/*.gcov'
      targetdir: '$(installDir)/Tests/Coverage/Report'
      reporttypes: 'Cobertura;SonarQube'
      tag: '$(product.Version.Full)'

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(installDir)/Tests/Coverage/Report/Cobertura.xml'
      pathToSources: '$(Build.SourcesDirectory)/Modules'
    continueOnError: true

  - task: SonarCloudAnalyze@1
    displayName: 'Analyze built sources with Sonar Scanner'

  - task: SonarCloudPublish@1
    displayName: 'Publish results of analysis to Sonar Cloud'
    inputs:
      pollingTimeoutSec: '300'