# Methane Kit CI configuration for Unix platforms
# https://aka.ms/yaml

parameters:
  - name: runTests
    type: boolean
    default: true
  - name: extraInitSteps
    type: stepList
    default: [ ]

steps:

  - ${{ each step in parameters.extraInitSteps }}:
      - ${{ step }}

  - task: CMake@1
    displayName: 'Check CMake version'
    inputs:
      cmakeArgs: '--version'

  - task: CMake@1
    displayName: 'Generate with configuration preset $(cmake.ConfigurePreset)'
    inputs:
      cmakeArgs: '--preset $(cmake.ConfigurePreset) $(cmake.ConfigureFlags)'

  - task: CMake@1
    displayName: 'Build with preset $(cmake.BuildPreset)'
    inputs:
      cmakeArgs: '--preset $(cmake.BuildPreset) --target install'

  - bash: |
      result_ext='_result.xml'
      echo Running unit-tests in directory $PWD
      for test_exe in *Test
      do
        ./$test_exe -r junit -o "$test_exe$result_ext"
        echo  - $test_exe - completed with $? exit status
      done
    workingDirectory: '$(installDir)/Tests'
    enabled: ${{ parameters.runTests }}
    displayName: 'Run all unit-tests from install directory'

  - script: |
      cp README.md $(installDir)/README.md
      echo Methane Kit v.$(product.Version.Full), git branch: $(Build.SourceBranchName), commit id: $(Build.SourceVersion) >$(installDir)/Build.txt
    displayName: 'Copy ReadMe and write build information'

  - task: CopyFiles@2
    displayName: 'Copy install artifacts of build $(cmake.BuildPreset)'
    inputs:
      SourceFolder: $(installDir)
      Contents: '**/*'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishTestResults@2
    enabled: ${{ parameters.runTests }}
    continueOnError: true
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles:  '**/*_result.xml'
      searchFolder: '$(Build.ArtifactStagingDirectory)/Tests'
      mergeTestResults: true
      failTaskOnFailedTests: true
      testRunTitle: 'Methane Tests $(cmake.BuildPreset)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish install built artifacts $(cmake.BuildPreset)'
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: MethaneKit-$(cmake.BuildPreset)_v$(product.Version.Full)
